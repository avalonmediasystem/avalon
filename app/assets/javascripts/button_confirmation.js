/*
 * Copyright 2011-2025, The Trustees of Indiana University and Northwestern
 *   University.  Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed
 *   under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
 *   CONDITIONS OF ANY KIND, either express or implied. See the License for the
 *   specific language governing permissions and limitations under the License.
 * ---  END LICENSE_HEADER BLOCK  ---
 */

// Store the previous active element before the popover is shown
let activeDeleteBtn = null;

// START: 'apply_button_confirmation' coffeescript to javascript conversion
document.addEventListener('DOMContentLoaded', function () {
  apply_button_confirmation();
});

window.apply_button_confirmation = function () {
  var btnList = [].slice.call(queryAll('.btn-confirmation'));
  btnList.map(function (btn) {
    return new bootstrap.Popover(btn, {
      trigger: 'manual',
      html: true,
      sanitize: false,
      container: '#main-content',
      content: function () {
        let button;
        if (typeof this.getAttribute('form') === "undefined" || this.getAttribute('form') === null) {
          button = `<a href="${this.getAttribute('href')}" class="btn btn-sm btn-danger btn-confirm" role="button" data-method="delete"
          rel="nofollow" data-testid="table-view-delete-confirmation-btn">Yes, Delete</a>`;
        } else {
          const formId = this.getAttribute('form');
          button = `<input class="btn btn-sm btn-danger btn-confirm" role="button" form="${formId}" type="submit" value="Yes, Delete">`;
          const form = getById(formId);
          if (form) {
            const methodInput = query('[name="_method"]', form);
            if (methodInput) methodInput.value = 'delete';
          }
        }
        return '<p>Are you sure?</p> ' + button + ' <a href="#" class="btn btn-sm btn-primary" role="button" id="special_button_color">No, Cancel</a>';
      }
    });
  });
};

// Initialize the cancel button within the popover
document.addEventListener('click', function (e) {
  if (e.target.id === 'special_button_color') {
    // Stop page from scrolling up on 'Cancel' click
    e.preventDefault();
    // Restore focus to the active delete button
    if (activeDeleteBtn) {
      bootstrap.Popover.getInstance(activeDeleteBtn).hide();
      activeDeleteBtn.focus();
    }
    return true;
  }
});

// 'confirm' is an event generated by rails
document.addEventListener('confirm', function (e) {
  if (e.target.classList.contains('btn-confirmation')) {
    if (activeDeleteBtn) {
      bootstrap.Popover.getInstance(activeDeleteBtn).hide();
    }
    bootstrap.Popover.getInstance(e.target).show();
    e.preventDefault();
    return false;
  }
});
// END: 'apply_button_confirmation' coffeescript to javascript conversion

// After showing the popover, focus the first button inside it for keyboard accessibility
document.addEventListener('shown.bs.popover', function (e) {
  if (e.target.classList.contains('btn-confirmation')) {
    // Store the current delete button as the active delete button
    activeDeleteBtn = e.target;
    // Get the popover id
    let popoverId = e.target.getAttribute('aria-describedby');
    if (popoverId) {
      let popover = getById(popoverId);
      if (popover) {
        let firstBtn = query('.btn', popover);
        if (firstBtn) {
          firstBtn.focus();
        }
      }
    }
  }
});

// Trap focus within the popover when it is opened
document.addEventListener('keydown', function (e) {
  // Only proceed if a popover is open
  let popoverIsOpen = query('.popover.show');
  if (popoverIsOpen) {
    // Find all focusable elements inside the popover
    let focusableEls = Array.from(queryAll('a[role="button"]', popoverIsOpen))
      .filter(el => { return el.offsetWidth > 0 && el.offsetHeight > 0; });
    if (!focusableEls.length) return;

    let first = focusableEls[0];
    let last = focusableEls[focusableEls.length - 1];

    // Trap focus with Tab and Shift+Tab
    if (e.key === 'Tab') {
      let active = document.activeElement;
      if (e.shiftKey) {
        if (active === first) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (active === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }
    // Close the popover when 'Esc' is pressed
    if (e.key === 'Escape') {
      e.preventDefault();
      // Hide all confirmation button popovers
      queryAll('.btn-confirmation').forEach(btn => {
        const popoverInstance = bootstrap.Popover.getInstance(btn);
        if (popoverInstance) {
          popoverInstance.hide();
        }
      });
      // Restore focus to the active delete button
      if (activeDeleteBtn) {
        activeDeleteBtn.focus();
      }
    }

  }
});
